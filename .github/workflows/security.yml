name: Security Scanning

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # Dependency vulnerability scanning
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run npm audit (JSON report)
        run: npm audit --json > audit-report.json || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

  # Container/dependency scanning with Trivy
  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: "trivy-results.sarif"

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          license-checker --summary --production > license-summary.txt
          echo "=== License Summary ==="
          cat license-summary.txt

      - name: Check for problematic licenses
        run: |
          # Fail if GPL or AGPL licenses are found in production deps
          if license-checker --production --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;Unlicense;0BSD;CC-BY-3.0;CC-BY-4.0;Python-2.0;BlueOak-1.0.0" 2>&1 | grep -q "FAIL"; then
            echo "::warning::Some licenses may need review"
          fi
        continue-on-error: true

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-summary.txt
          retention-days: 30

  # Secret scanning (supplementary to GitHub's built-in)
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Only fetch the current commit, not full history
          # PR refs contain rotated secrets from before cleanup that cannot be removed
          fetch-depth: 1

      - name: TruffleHog Filesystem Scan
        # Scan only current files, NOT git history
        # PR refs contain old rotated secrets that cannot be removed from GitHub
        run: |
          echo "Scanning filesystem only (not git history)..."
          docker run --rm -v "$PWD:/repo:ro" ghcr.io/trufflesecurity/trufflehog:latest \
            filesystem /repo \
            --only-verified \
            --fail || exit_code=$?
          if [ "${exit_code:-0}" -eq 183 ]; then
            echo "::error::TruffleHog found verified secrets in current files!"
            exit 1
          fi
          echo "No secrets found in current files."

  # CodeQL analysis for JavaScript/TypeScript
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"
