name: Release Guard

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Debug secrets presence (safe)
        run: |
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then echo "NEXT_PUBLIC_SUPABASE_URL: EMPTY (0)"; else echo "NEXT_PUBLIC_SUPABASE_URL: PRESENT (${#NEXT_PUBLIC_SUPABASE_URL})"; fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "SUPABASE_SERVICE_ROLE_KEY: EMPTY (0)"; else echo "SUPABASE_SERVICE_ROLE_KEY: PRESENT (${#SUPABASE_SERVICE_ROLE_KEY})"; fi
          if [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then echo "NEXT_PUBLIC_SUPABASE_ANON_KEY: EMPTY (0)"; else echo "NEXT_PUBLIC_SUPABASE_ANON_KEY: PRESENT (${#NEXT_PUBLIC_SUPABASE_ANON_KEY})"; fi
        continue-on-error: true

      - name: Run security audit
        run: npm run audit:security

  wallet-smoke:
    name: Wallet Smoke Tests (non-blocking)
    runs-on: ubuntu-latest
    # Governance:
    # - Questo job è intenzionalmente NON bloccante durante il periodo di stabilizzazione.
    # - Diventerà BLOCKING dopo stabilizzazione (rimuovere continue-on-error e/o fallire la pipeline).
    #
    # (Opzionale - hardening futuro): limitare l'esecuzione ai soli path rilevanti:
    # - app/api/shipments/**
    # - lib/shipments/**
    # - lib/wallet/**
    # - lib/services/couriers/**
    # - scripts/smoke-*.ts
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run wallet smoke tests (non-blocking)
        run: npm run smoke:wallet
        # ⏳ Stabilizzazione: non bloccare ancora il merge/deploy.
        # Dopo stabilizzazione: rimuovere continue-on-error (diventa blocking).
        continue-on-error: true
