-- =====================================================
-- Script: test-fee-security-vulnerability.sql
-- Descrizione: Test P0 - Verifica vulnerabilità IDOR in funzioni RPC
-- =====================================================

-- ⚠️ QUESTO SCRIPT DEVE FALLIRE DOPO LA FIX (migration 113)
-- ⚠️ Se ritorna dati → VULNERABILE
-- ⚠️ Se ritorna errore "Access denied" → SICURO

BEGIN;

-- Setup: Crea 2 utenti di test
INSERT INTO users (id, email, role, account_type, platform_fee_override)
VALUES
  ('00000000-0000-0000-0000-000000000001', 'victim@example.com', 'USER', 'user', 2.50),
  ('00000000-0000-0000-0000-000000000002', 'attacker@example.com', 'USER', 'user', NULL)
ON CONFLICT (id) DO NOTHING;

-- Simula autenticazione come attacker
SET LOCAL request.jwt.claims TO '{"sub": "00000000-0000-0000-0000-000000000002"}';

-- ⚠️ TEST 1: Attacker tenta di leggere fee della vittima
-- EXPECTED BEHAVIOR (DOPO FIX):
--   ERROR: Access denied: You are not authorized to view fees for user 00000000-0000-0000-0000-000000000001

SELECT 'TEST 1: get_platform_fee_cascading' AS test_name;
SELECT get_platform_fee_cascading('00000000-0000-0000-0000-000000000001') AS fee;
-- ❌ VULNERABILE se ritorna 2.50
-- ✅ SICURO se ritorna errore "Access denied"

-- ⚠️ TEST 2: Attacker tenta di leggere dettagli fee della vittima
SELECT 'TEST 2: get_platform_fee_details' AS test_name;
SELECT * FROM get_platform_fee_details('00000000-0000-0000-0000-000000000001');
-- ❌ VULNERABILE se ritorna (fee: 2.50, source: custom, source_user_email: victim@example.com)
-- ✅ SICURO se ritorna errore "Access denied"

-- ⚠️ TEST 3: Attacker può leggere la propria fee (DEVE funzionare)
SELECT 'TEST 3: get_platform_fee_cascading (self)' AS test_name;
SELECT get_platform_fee_cascading('00000000-0000-0000-0000-000000000002') AS fee;
-- ✅ DEVE ritornare la propria fee (0.50 default)

ROLLBACK;

-- =====================================================
-- COME ESEGUIRE:
-- psql -h project-ref.supabase.co -U postgres.project-ref -d postgres -f test-fee-security-vulnerability.sql
-- =====================================================
