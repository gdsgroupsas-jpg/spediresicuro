# üìú SpedireSicuro.it - Technical Documentation

> **Version:** 3.0.0 (Production-Ready Architecture)  
> **Last Updated:** December 21, 2025  
> **Status:** üü¢ Production (Core Features) / üü° Development (AI Modules)

---

## üéØ What is SpedireSicuro?

**SpedireSicuro** is a modern shipping management platform that simplifies logistics for businesses and individuals.

### Core Value Proposition

- **Multi-Carrier Management** - Compare prices and ship with GLS, BRT, Poste Italiane from one dashboard
- **Prepaid Wallet System** - Pay-as-you-go with transparent pricing, no monthly fees
- **Reseller Support** - Build your own shipping business with custom pricing tiers
- **Enterprise Security** - Multi-tenant architecture with impersonation support for customer service

### Design Principles

1. **Security First** - Row-level security (RLS), audit logging, GDPR compliance
2. **Financial Integrity** - Immutable wallet ledger, fraud prevention, manual approval workflow
3. **Operational Excellence** - Comprehensive monitoring, incident playbooks, fail-safe recovery
4. **Developer Experience** - Type-safe APIs, extensive documentation, clear architecture

---

## üèóÔ∏è Technology Stack

### Frontend
- **Next.js 14** - App Router with React Server Components
- **TypeScript** - Strict type checking
- **Tailwind CSS + Shadcn/UI** - Modern component library
- **Framer Motion** - Smooth animations

### Backend
- **Next.js API Routes** - RESTful endpoints
- **Server Actions** - Type-safe RPC calls
- **Supabase** - PostgreSQL with Row Level Security (RLS)
- **NextAuth.js v5** - Authentication and session management

### Infrastructure
- **Database:** Supabase (PostgreSQL 15+)
- **Hosting:** Vercel (Edge Network)
- **Monitoring:** Vercel Analytics + Custom diagnostics
- **Payments:** Bank Transfer (Manual) + XPay integration (Ready, not live)

---

## üì¶ Features

### ‚úÖ Live in Production

#### üöö Shipment Management
- Multi-carrier support (GLS, BRT, Poste via Spedisci.Online)
- Real-time tracking
- Label generation and download
- Shipment history and search

#### üí∞ Wallet System
- Prepaid credit model (‚Ç¨10k max per transaction)
- Bank transfer top-ups (manual admin approval)
- Immutable transaction ledger
- Negative balance prevention
- Daily balance reconciliation

#### üë• User Management
- Role-based access control (User, Admin, SuperAdmin)
- Reseller hierarchy (parent-child relationships)
- Custom pricing per reseller
- Acting Context (Impersonation for customer support)

#### üîí Security & Compliance
- Multi-tenant isolation (Row Level Security)
- Comprehensive audit logging (all sensitive operations)
- GDPR data export and anonymization
- Encrypted courier credentials
- Session management with TTL

#### üíº CRM
- Lead management (New ‚Üí Contacted ‚Üí Qualified ‚Üí Won/Lost)
- Lead assignment to sales team
- One-click conversion to active user

### üü° Partially Implemented (Backend Ready, UI Missing)

#### ü§ñ AI Features
- **Infrastructure:** Gemini 2.0 Flash integration ready
- **Missing:** Chat UI interface for "Anne" assistant
- **Use Case:** Automated shipment data extraction from images

#### üí≥ Payment Processing
- **Infrastructure:** XPay (Intesa Sanpaolo) integration ready
- **Missing:** Payment flow UI, testing in production
- **Current:** Manual bank transfer only

#### üìä Diagnostics Dashboard
- **Infrastructure:** `diagnostics_events` table logging active
- **Missing:** Admin UI to view and analyze events
- **Current:** SQL queries for diagnostics

#### üìÑ Invoice System
- **Infrastructure:** Tables and schema created
- **Missing:** PDF generation, email delivery
- **Current:** Manual invoice creation

---

## üöÄ Quick Start

### Prerequisites
- Node.js 18+ and npm
- Supabase account (cloud or local)
- Basic understanding of Next.js and TypeScript

### Local Development Setup

**Option 1: Supabase Cloud (Recommended for getting started)**
```bash
# 1. Clone repository
git clone https://github.com/gdsgroupsas-jpg/spediresicuro.git
cd spediresicuro

# 2. Install dependencies
npm install

# 3. Configure environment
cp .env.example .env.local
# Edit .env.local with your Supabase credentials

# 4. Verify setup
npm run setup:check

# 5. Start development server
npm run dev
```

**Option 2: Supabase Local (Advanced)**
```bash
# 1-2. Same as above

# 3. Start Supabase locally (requires Docker)
npx supabase start

# 4. Configure .env.local with local URLs
# (Provided by supabase start command)

# 5-6. Same as above
```

### Environment Variables

Copy `.env.example` to `.env.local` and configure:

```bash
# Required
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your_random_secret_32_chars
ENCRYPTION_KEY=your_encryption_key_32_chars

# Optional (for full functionality)
GOOGLE_API_KEY=your_gemini_api_key
GOOGLE_CLIENT_ID=your_google_oauth_id
GOOGLE_CLIENT_SECRET=your_google_oauth_secret
```

See [`.env.example`](.env.example) for complete list.

---

## üìö Documentation

### Essential Reading
- **[SECURITY.md](docs/SECURITY.md)** - Multi-tenant architecture, Acting Context, RLS policies
- **[MONEY_FLOWS.md](docs/MONEY_FLOWS.md)** - Wallet system, anti-fraud, idempotency
- **[OPS_RUNBOOK.md](docs/OPS_RUNBOOK.md)** - Deployment, incident response, monitoring
- **[DB_SCHEMA.md](docs/DB_SCHEMA.md)** - Database tables, RLS policies, invariants
- **[MIGRATIONS.md](docs/MIGRATIONS.md)** - Migration history, rollback procedures
- **[ARCHITECTURE.md](docs/ARCHITECTURE.md)** - Technical deep dive, patterns, performance

### Additional Resources
- **[ROADMAP.md](ROADMAP.md)** - Planned features and backlog
- **[CONTRIBUTING.md](CONTRIBUTING.md)** - Developer guidelines and PR checklist

---

## üß™ Testing

```bash
# Run type checking
npm run type-check

# Run linting
npm run lint

# Run tests (when available)
npm test

# E2E tests with Playwright
npm run test:e2e
```

---

## üö¢ Deployment

### Vercel (Recommended)

1. Push code to GitHub
2. Import project in Vercel dashboard
3. Configure environment variables
4. Deploy automatically on every push to `main`

See [OPS_RUNBOOK.md](docs/OPS_RUNBOOK.md) for detailed deployment checklist.

---

## üîê Security

- **Multi-Tenant Isolation:** Row Level Security (RLS) on all tenant tables
- **Audit Logging:** All sensitive operations logged with actor/target tracking
- **Impersonation:** SuperAdmin can act on behalf of users (fully audited)
- **Encryption:** Courier credentials encrypted at rest
- **GDPR:** Data export and anonymization support

See [SECURITY.md](docs/SECURITY.md) for security architecture details.

---

## ü§ù Contributing

We welcome contributions! Please read [CONTRIBUTING.md](CONTRIBUTING.md) for:
- Code review checklist
- Security gate requirements
- Migration best practices
- ESLint rules (no direct `auth()` usage)

---

## üìú License

[Add your license here]

---

## üìû Support

- **Documentation:** See `docs/` folder
- **Issues:** GitHub Issues
- **Email:** [Add support email]

---

_Last updated: December 21, 2025_

- **Self-Monitoring**: Tabella `diagnostics_events` che traccia errori, warning e performance.
- **Automation**: Se l'Automation Service crasha o un login corriere fallisce, il Doctor notifica.
- **AI Analysis**: L'AI pu√≤ analizzare i log per suggerire fix al codice o alla configurazione.

---

## üóÑÔ∏è 4. ARCHITETTURA DATI (Supabase)

Schema database PostgreSQL chiave per lo sviluppo:

- `users`: Profili estesi, collegamenti padre-figlio (Reseller), preferenze.
- `shipments`: Tabella centrale spedizioni. Include campi JSONB per dettagli corrieri.
- `leads`: (Nuova) Gestione CRM pre-acquisizione.
- `wallet_transactions`: Storico immutabile di ricariche e spese.
- `wallet_topups`: Richieste di ricarica (Stato: pending -> approved/rejected) con link alle ricevute.
- `diagnostics_events`: Log strutturati (JSONB context) per debugging.

---

## üöÄ 5. FLUSSI OPERATIVI CHIAVE

### Flusso "Smart Top-Up" (Ricarica Bonifico)

1.  Utente apre dialogo Wallet -> Tab "Bonifico".
2.  Upload PDF/JPG distinta.
3.  Frontend invia file a Server Action.
4.  Gemini AI analizza documento -> Estrae Importo, Data, CRO.
5.  Record creato in `wallet_topups` (Status: `pending_verification`).
6.  Admin riceve notifica -> Approva -> Transazione scritta in `wallet_transactions` -> Saldo aggiornato.

### Flusso "AI Booking" (Anne)

1.  Utente incolla screenshot WhatsApp in chat.
2.  Gemini Vision analizza immagine -> Estrae indirizzo dest e mittente nascosto.
3.  LangGraph valida indirizzi (Geocoding check).
4.  L'AI chiede: "Vuoi assicurare il pacco per 500‚Ç¨ come scritto nella chat?".
5.  Utente conferma -> Spedizione creata in bozza.

---

## üõ†Ô∏è 6. SETUP & SVILUPPO

### Variabili d'Ambiente Critiche (.env.local)

```bash
# Core
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...

# NextAuth
NEXTAUTH_URL=http://localhost:3000  # ‚ö†Ô∏è Solo per sviluppo locale
NEXTAUTH_SECRET=...

# AI (Cervello)
GOOGLE_API_KEY=...      # Gemini 2.0 Flash Key

# Payments
XPAY_BO_API_KEY=...     # Banca Intesa Backoffice
XPAY_TERMINAL_ID=...    # Terminale POS Virtuale

# Automation
AUTOMATION_SERVICE_URL=http://localhost:3000
```

### üöÄ Percorsi di Sviluppo

Il progetto supporta **due percorsi di sviluppo** a seconda delle tue esigenze:

#### **Percorso 1: Sviluppo con Supabase Cloud** (Consigliato per iniziare)

**Requisiti:**
- ‚úÖ Account Supabase Cloud (gratuito)
- ‚úÖ File `.env.local` configurato con credenziali Supabase Cloud
- ‚ùå **NON richiede Docker**

**Setup:**
```bash
# 1. Verifica configurazione
npm run setup:check

# 2. Avvia sviluppo
npm run dev
```

**Verifiche:**
- ‚úÖ `npm run check:env:simple` ‚Üí PASS
- ‚úÖ `npm run check:errors` ‚Üí PASS
- ‚ö†Ô∏è `npx supabase status` ‚Üí WARN (Docker non necessario)

**Vantaggi:**
- Setup rapido (no Docker)
- Database cloud sempre disponibile
- Ideale per sviluppo collaborativo

---

#### **Percorso 2: Sviluppo con Supabase Locale**

**Requisiti:**
- ‚úÖ Docker Desktop installato e in esecuzione
- ‚úÖ File `.env.local` configurato
- ‚úÖ Supabase CLI installato (`npm install -g supabase`)

**Setup:**
```bash
# 1. Avvia Supabase locale
npx supabase start

# 2. Verifica configurazione
npm run setup:check

# 3. Avvia sviluppo
npm run dev
```

**Verifiche:**
- ‚úÖ `npm run check:env:simple` ‚Üí PASS
- ‚úÖ `npm run check:errors` ‚Üí PASS
- ‚úÖ `npx supabase status` ‚Üí PASS

**Vantaggi:**
- Database locale isolato
- Controllo completo su migrations
- Ideale per test offline

---

### üìã Comandi Utili

```bash
# Verifica setup completo (consigliato prima di iniziare)
npm run setup:check

# Sviluppo
npm run dev          # Avvio Next.js

# Verifiche
npm run check:env:simple  # Verifica variabili .env.local
npm run check:errors      # Verifica errori nel log

# Supabase (solo se locale)
npx supabase status      # Verifica Supabase locale
npx supabase start       # Avvia Supabase locale
npx supabase stop        # Ferma Supabase locale
```

---

_Questo documento √® la Verit√†. Se il codice differisce da questo documento, il codice deve essere aggiornato o questo documento emendato tramite PR._
